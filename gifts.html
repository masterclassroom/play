<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Buy or Withdraw Gifts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      color: #333;
      padding: 20px;
      max-width: 400px;
      margin: auto;
      padding-bottom: 70px; /* space for fixed back button */
    }
    h2 {
      text-align: center;
      color: #007bff;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    select, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
      cursor: pointer;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      margin-top: 20px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
    #coinsDisplay {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
      font-size: 18px;
      color: #444;
    }
    #giftsDisplay {
      margin-top: 20px;
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      font-size: 16px;
      color: #333;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #giftsDisplay h3 {
      margin-top: 0;
      text-align: center;
      color: #007bff;
    }
    #giftsDisplay ul {
      list-style: none;
      padding: 0;
    }
    #giftsDisplay li {
      margin-bottom: 8px;
      font-weight: bold;
    }

    /* Back button fixed at bottom */
    #backBtn {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      padding: 12px;
      background-color: #555;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: background-color 0.3s ease;
      z-index: 1000;
    }
    #backBtn:hover {
      background-color: #333;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <h2>Buy or Withdraw Gifts</h2>

  <label for="giftSelect">Select Gift Level</label>
  <select id="giftSelect">
    <option value="low">Low (100 coins)</option>
    <option value="medium">Medium (500 coins)</option>
    <option value="high">High (1000 coins)</option>
  </select>

  <label for="actionSelect">Select Action</label>
  <select id="actionSelect">
    <option value="buy">Buy</option>
    <option value="withdraw">Withdraw</option>
  </select>

  <button id="actionBtn">Buy</button>

  <div id="coinsDisplay">Loading coins...</div>

  <div id="giftsDisplay">
    <h3>Your Gifts</h3>
    <ul>
      <li>Low: <span id="giftLow">0</span></li>
      <li>Medium: <span id="giftMedium">0</span></li>
      <li>High: <span id="giftHigh">0</span></li>
    </ul>
  </div>

  <button id="backBtn" onclick="history.back()">⬅️ Back</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAj0xbIZhcmWiSf3nYVgIIgTZ_KJ64mTE",
      authDomain: "exam-81b90.firebaseapp.com",
      databaseURL: "https://exam-81b90-default-rtdb.firebaseio.com",
      projectId: "exam-81b90",
      storageBucket: "exam-81b90.appspot.com",
      messagingSenderId: "461178422237",
      appId: "1:461178422237:web:8433ab42b524b0a17bac34"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    let giftValues = {
      low: 100,
      medium: 500,
      high: 1000
    };

    const giftSelect = document.getElementById("giftSelect");
    const actionSelect = document.getElementById("actionSelect");
    const actionBtn = document.getElementById("actionBtn");
    const coinsDisplay = document.getElementById("coinsDisplay");
    const giftLow = document.getElementById("giftLow");
    const giftMedium = document.getElementById("giftMedium");
    const giftHigh = document.getElementById("giftHigh");

    let currentUserUid = null;
    let currentUserData = {};

    function updateCoinsDisplay() {
      coinsDisplay.innerText = `Your coins: ${currentUserData.coins || 0}`;
    }

    function updateGiftsDisplay() {
      const gifts = currentUserData.gifts || {};
      giftLow.innerText = gifts.low || 0;
      giftMedium.innerText = gifts.medium || 0;
      giftHigh.innerText = gifts.high || 0;
    }

    // Update button text when action changes
    actionSelect.addEventListener("change", () => {
      const val = actionSelect.value;
      actionBtn.innerText = val === "buy" ? "Buy" : "Withdraw";
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        Swal.fire("Please log in first");
        location.href = "login.html";
        return;
      }
      currentUserUid = user.uid;

      // Load user data
      const userSnap = await get(ref(db, `users/${currentUserUid}`));
      if (userSnap.exists()) {
        currentUserData = userSnap.val();
        updateCoinsDisplay();
        updateGiftsDisplay();
      } else {
        coinsDisplay.innerText = "Error loading coins.";
      }
    });

    actionBtn.addEventListener("click", async () => {
      if (!currentUserUid) return;

      const selectedGift = giftSelect.value;
      const selectedAction = actionSelect.value;
      const giftCost = giftValues[selectedGift] || 0;
      const coins = currentUserData.coins || 0;
      const gifts = currentUserData.gifts || {};

      if (selectedAction === "buy") {
        if (coins < giftCost) {
          Swal.fire("Insufficient coins", `You need ${giftCost} coins to buy a ${selectedGift} gift.`, "error");
          return;
        }

        Swal.fire({
          title: `Buy ${selectedGift} gift?`,
          text: `It will cost you ${giftCost} coins.`,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Yes, buy it!"
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              // Update coins and gifts in database
              gifts[selectedGift] = (gifts[selectedGift] || 0) + 1;
              const updates = {
                coins: coins - giftCost,
                gifts: gifts
              };
              await update(ref(db, `users/${currentUserUid}`), updates);

              currentUserData.coins -= giftCost;
              currentUserData.gifts = gifts;
              updateCoinsDisplay();
              updateGiftsDisplay();

              Swal.fire("Success!", `You bought 1 ${selectedGift} gift.`, "success");
            } catch (e) {
              console.error(e);
              Swal.fire("Error", "Failed to buy gift.", "error");
            }
          }
        });
      } else if (selectedAction === "withdraw") {
        if ((gifts[selectedGift] || 0) < 1) {
          Swal.fire("No gifts", `You don't have any ${selectedGift} gifts to withdraw.`, "error");
          return;
        }

        Swal.fire({
          title: `Withdraw ${selectedGift} gift?`,
          text: `This will remove 1 ${selectedGift} gift and add ${giftCost} coins to your balance.`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Yes, withdraw"
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              gifts[selectedGift] = gifts[selectedGift] - 1;
              const updates = {
                coins: coins + giftCost,
                gifts: gifts
              };
              await update(ref(db, `users/${currentUserUid}`), updates);

              currentUserData.coins += giftCost;
              currentUserData.gifts = gifts;
              updateCoinsDisplay();
              updateGiftsDisplay();

              Swal.fire("Success!", `You withdrew 1 ${selectedGift} gift and gained ${giftCost} coins.`, "success");
            } catch (e) {
              console.error(e);
              Swal.fire("Error", "Failed to withdraw gift.", "error");
            }
          }
        });
      }
    });
  </script>

</body>
</html>
