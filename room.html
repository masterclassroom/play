<!DOCTYPE html>
<html lang="so">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Room Match</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      background: #0f2027;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 30px;
    }
    img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 10px;
    }
    .copy-btn, .ready-btn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .copy-btn {
      background-color: #3498db;
      color: white;
    }
    .ready-btn {
      background-color: #00cec9;
      color: white;
      margin-top: 15px;
    }
    #playersCount, #timer {
      margin-top: 20px;
      font-size: 18px;
      color: #f1c40f;
    }
    .opponent-container {
      position: relative;
      display: inline-block;
    }
    #inviteBtn {
      position: absolute;
      bottom: 0;
      left: 0;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Room Match</h1>
  <p>Room ID: <span id="roomIdText"></span></p>
  <button class="copy-btn" onclick="copyRoomId()">Copy Room ID</button>
  <button class="copy-btn" id="backBtn">Back</button>

  <div>
    <img id="homeProfile" src="default.png" alt="Home" />
    
    <div class="opponent-container">
      <img id="awayProfile" src="default.png" alt="Away" />
      <button id="inviteBtn" title="Invite Friend">+</button>
    </div>
  </div>

  <div>
    <p id="homeName">Home: Waiting...</p>
    <p id="awayName">Away: Waiting...</p>
  </div>

  <button class="ready-btn" id="readyBtn">Ready</button>
  <p id="playersCount">Players Ready: 0/2</p>
  <p id="timer">Time Left: 120s</p>

  <audio id="notifySound" src="ding.mp3" preload="auto"></audio>
<script src="g.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAj0xbIZhcmWiSf3nYVgIIgTZ_KJ64mTE",
      authDomain: "exam-81b90.firebaseapp.com",
      databaseURL: "https://exam-81b90-default-rtdb.firebaseio.com",
      projectId: "exam-81b90",
      storageBucket: "exam-81b90.appspot.com",
      messagingSenderId: "461178422237",
      appId: "1:461178422237:web:8433ab42b524b0a17bac34"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const urlParams = new URLSearchParams(location.search);
    const roomId = urlParams.get("room");
    const role = urlParams.get("role");

    const roomIdText = document.getElementById("roomIdText");
    const homeProfile = document.getElementById("homeProfile");
    const awayProfile = document.getElementById("awayProfile");
    const homeName = document.getElementById("homeName");
    const awayName = document.getElementById("awayName");
    const readyBtn = document.getElementById("readyBtn");
    const playersCount = document.getElementById("playersCount");
    const timerEl = document.getElementById("timer");
    const backBtn = document.getElementById("backBtn");
    const inviteBtn = document.getElementById("inviteBtn");
    const notifySound = document.getElementById("notifySound");

    roomIdText.innerText = roomId;

    let currentUser = null;
    let seconds = 120;
    let timerStarted = false;
    let timerInterval = null;
    const roomRef = ref(db, `rooms/${roomId}`);

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "login.html";
      currentUser = user;
      const myUid = currentUser.uid;

      if (!roomId || !role) {
        await Swal.fire("Invalid game parameters");
        return location.href = "home.html";
      }

      // Role check & validation
      if (role === "away") {
        const homeSnap = await get(ref(db, `rooms/${roomId}/home`));
        if (!homeSnap.exists()) {
          await Swal.fire("Room creator left");
          await set(ref(db, `rooms/${roomId}`), null);
          return location.href = "home.html";
        }

        const awaySnap = await get(ref(db, `rooms/${roomId}/away`));
        if (!awaySnap.exists() || awaySnap.val() !== myUid) {
          await Swal.fire("You are no part of the room");
          return location.href = "home.html";
        }
      }

      if (role === "home") {
        const homeSnap = await get(ref(db, `rooms/${roomId}/home`));
        if (!homeSnap.exists() || homeSnap.val() !== myUid) {
          await Swal.fire("Access denied");
          return location.href = "home.html";
        }
      }

      // Load my profile
      const meSnap = await get(ref(db, `users/${myUid}`));
      if (meSnap.exists()) {
        const me = meSnap.val();
        const image = me.logo ? `./${me.logo}.png` : "default.png";
        const name = me.username || "Aniga";
        if (role === "home") {
          homeProfile.src = image;
          homeName.innerText = `Home: ${name}`;
        } else {
          awayProfile.src = image;
          awayName.innerText = `Away: ${name}`;
        }
      }

      // Opponent profile & invite button visibility
      const otherRole = role === "home" ? "away" : "home";
      onValue(ref(db, `rooms/${roomId}/${otherRole}`), async (snap) => {
        const otherUid = snap.val();
        inviteBtn.style.display = otherUid ? "none" : "block";

        if (otherUid) {
          const otherSnap = await get(ref(db, `users/${otherUid}`));
          if (otherSnap.exists()) {
            const other = otherSnap.val();
            const image = other.logo ? `./${other.logo}.png` : "default.png";
            const name = other.username || "Saaxiib";
            if (role === "home") {
              awayProfile.src = image;
              awayName.innerText = `Away: ${name}`;
            } else {
              homeProfile.src = image;
              homeName.innerText = `Home: ${name}`;
            }
          }
        } else {
          if (role === "home") {
            awayProfile.src = "default.png";
            awayName.innerText = "Away: Waiting...";
          } else {
            homeProfile.src = "default.png";
            homeName.innerText = "Home: Waiting...";
          }
        }
      });

      // Listen invites for current user
      

      // Room data changes: ready players count & timer
      onValue(roomRef, async (snap) => {
        if (!snap.exists()) {
          await Swal.fire("Match room closed");
          location.href = "matchmaking.html";
          return;
        }

        const data = snap.val();
        if (data.home !== myUid && data.away !== myUid) {
          await Swal.fire("You are no longer in this game");
          location.href = "matchmaking.html";
          return;
        }

        const r1 = data.homeReady ? 1 : 0;
        const r2 = data.awayReady ? 1 : 0;
        playersCount.innerText = `Players Ready: ${r1 + r2}/2`;

        if ((r1 + r2) >= 1 && !timerStarted) {
          timerStarted = true;
          timerInterval = setInterval(() => {
            seconds--;
            if (seconds >= 0) {
              timerEl.innerText = `Time Left: ${seconds}s`;
            } else {
              timerEl.innerText = "Time's up!";
              clearInterval(timerInterval);

              if (data.homeReady && data.awayReady && data.type === "friendmatch") {
                const myRole = data.host === currentUser.uid ? "home" : "away";
                location.href = `game.html?room=${roomId}&role=${myRole}&stake=10`;
              }
            }
          }, 1000);
        }

        if (data.homeReady && data.awayReady && seconds > 0 && data.type === "friendmatch") {
          clearInterval(timerInterval);
          const myRole = data.host === currentUser.uid ? "home" : "away";
          location.href = `game.html?room=${roomId}&role=${myRole}&stake=10`;
        }
      });

      // Ready button
      readyBtn.onclick = async () => {
        await set(ref(db, `rooms/${roomId}/${role}Ready`), true);
        Swal.fire({
          title: "Ready!",
          text: "Waiting for opponent...",
          icon: "info",
          confirmButtonText: "Cancel",
          preConfirm: () => {
            return set(ref(db, `rooms/${roomId}/${role}Ready`), false);
          }
        });
      };

      // Back button
      backBtn.onclick = async () => {
        if (role === "away") {
          const res = await Swal.fire({
            title: "Leave room?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes"
          });
          if (res.isConfirmed) {
            await set(ref(db, `rooms/${roomId}/away`), null);
            await set(ref(db, `rooms/${roomId}/awayReady`), null);
            history.back();
          }
        } else {
          const res = await Swal.fire({
            title: "Close this room?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes"
          });
          if (res.isConfirmed) {
            await set(ref(db, `rooms/${roomId}`), null);
            history.back();
          }
        }
      };

      // Invite button click: show friends list from friends/{myUid}
      inviteBtn.onclick = async () => {
        const friendsSnap = await get(ref(db, `friends/${myUid}`));
        if (!friendsSnap.exists()) {
          return Swal.fire("You have no friends to invite");
        }
        const friendsData = friendsSnap.val();

        // Load detailed user data for each friend
        let html = "";
        for (const friendUid in friendsData) {
          const userSnap = await get(ref(db, `users/${friendUid}`));
          if (userSnap.exists()) {
            const u = userSnap.val();
            const img = u.logo ? `./${u.logo}.png` : "default.png";
            const name = u.username || "Unknown";
            html += `
              <div style="display:flex;align-items:center;margin:10px 0;">
                <img src="${img}" style="width:40px;height:40px;border-radius:50%;margin-right:10px;">
                <span style="flex:1;">${name}</span>
                <button onclick="sendInvite('${friendUid}')" style="padding:5px 10px;">Invite</button>
              </div>
            `;
          }
        }
        Swal.fire({ title: "Invite a Friend", html, showConfirmButton: false });
      };

      // Send invite function
      window.sendInvite = async (toUid) => {
        await set(ref(db, `invites/${toUid}/${currentUser.uid}`), {
          roomId,
          from: currentUser.uid,
          timestamp: Date.now()
        });
        Swal.fire("Invite sent!");
      };
    });

    // Copy Room ID to clipboard
    window.copyRoomId = () => {
      navigator.clipboard.writeText(roomId);
      Swal.fire("Copied!", "Room ID copied to clipboard", "success");
    };
  </script>
</body>
</html>
