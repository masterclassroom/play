<!DOCTYPE html>
<html lang="so">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Football Match ‚Äì Matchmaking</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { 
      background: #000; 
      color: white; 
      font-family: 'Arial', sans-serif; 
      text-align: center; 
      padding: 20px; 
      max-width: 800px; 
      margin: 0 auto;
      line-height: 1.6;
    }
    select, button { 
      font-size: 18px; 
      padding: 12px; 
      margin: 15px auto; 
      width: 100%; 
      max-width: 300px; 
      border-radius: 8px; 
      border: none; 
      cursor: pointer; 
      display: block; 
      transition: all 0.3s ease;
    }
    select {
      background: #222;
      color: white;
      border: 1px solid #444;
    }
    #createBtn { 
      background: #28a745; 
      color: white; 
    }
    #createBtn:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    #joinBtn { 
      background: #007bff; 
      color: white; 
    }
    #joinBtn:hover {
      background: #0069d9;
      transform: translateY(-2px);
    }
    #coinsDisplay, #statusText, #roleInfo { 
      font-size: 20px; 
      margin: 20px; 
      color: #ffcc00;
      font-weight: bold;
    }
    .loading { 
      color: #aaa; 
      font-style: italic; 
    }
    .error { 
      color: #ff4444; 
    }
    .success { 
      color: #00C851; 
    }
    .container {
      background: rgba(0,0,0,0.7);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    h1 {
      color: #4CAF50;
      margin-bottom: 30px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .loading-spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 4px solid #007bff;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #rank { 
      background: #007bff; 
      color: white; 
    }
    #rank:hover {
      background: #0069d9;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Online Football Match</h1>
    <div id="coinsDisplay">Coins: 0</div>

    <select id="stakeCoins">
      <option value="10">10 Coins</option>
      <option value="20">20 Coins</option>
      <option value="30">30 Coins</option>
      <option value="40">40 Coins</option>
      <option value="50">50 Coins</option>
      <option value="60">60 Coins</option>
      <option value="70">70 Coins</option>
      <option value="80">80 Coins</option>
      <option value="90">90 Coins</option>
      <option value="100">100 Coins</option>
    </select>

    <button id="createBtn">Create Room</button>
    <button id="joinBtn">Join Room</button>
    <button onclick="rank()" id="rank">Ranking</button>

    <div class="loading-spinner" id="loadingSpinner"></div>
    <div id="statusText"></div>
    <div id="roleInfo"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, onValue, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAj0xbIZhcmWiSf3nYVgIIgTZ_KJ64mTE",
      authDomain: "exam-81b90.firebaseapp.com",
      databaseURL: "https://exam-81b90-default-rtdb.firebaseio.com",
      projectId: "exam-81b90",
      storageBucket: "exam-81b90.appspot.com",
      messagingSenderId: "461178422237",
      appId: "1:461178422237:web:8433ab42b524b0a17bac34",
      measurementId: "G-KKDNZBZLPG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    let myUid = null;
    let myCoins = 0;
    let roomListener = null;
    let coinsListener = null;

    const stakeSelect = document.getElementById("stakeCoins");
    const coinsDisplay = document.getElementById("coinsDisplay");
    const statusText = document.getElementById("statusText");
    const roleInfo = document.getElementById("roleInfo");
    const createBtn = document.getElementById("createBtn");
    const joinBtn = document.getElementById("joinBtn");
    const loadingSpinner = document.getElementById("loadingSpinner");

    function updateCoinsDisplay(coins) {
      myCoins = coins;
      coinsDisplay.innerText = `Coins: ${myCoins}`;
    }

    function setLoading(loading) {
      createBtn.disabled = loading;
      joinBtn.disabled = loading;
      if (loading) {
        loadingSpinner.style.display = 'block';
      } else {
        loadingSpinner.style.display = 'none';
      }
    }

    function showStatus(message, type = "") {
      statusText.innerText = message;
      statusText.className = type;
    }

    async function cleanup() {
      if (roomListener) {
        roomListener();
        roomListener = null;
      }
      if (coinsListener) {
        coinsListener();
        coinsListener = null;
      }
    }

    async function handleAuthError(error) {
      console.error("Authentication error:", error);
      await Swal.fire({
        title: 'Session Expired',
        text: 'Please login again',
        icon: 'error'
      });
      await signOut(auth);
      location.href = 'login.html';
    }

    onAuthStateChanged(auth, async (user) => {
      try {
        if (!user) {
          location.href = "login.html";
          return;
        }
        
        myUid = user.uid;
        setLoading(true);
        
        // Clean up previous listeners
        await cleanup();

        // Load initial coins
        const snap = await get(ref(db, `users/${myUid}/coins`));
        updateCoinsDisplay(snap.exists() ? snap.val() : 0);

        // Setup coins listener
        coinsListener = onValue(ref(db, `users/${myUid}/coins`), (snap) => {
          if (snap.exists()) {
            updateCoinsDisplay(snap.val());
          }
        }, (error) => {
          handleAuthError(error);
        });

        setLoading(false);
      } catch (error) {
        handleAuthError(error);
      }
    });

    createBtn.addEventListener("click", async () => {
      try {
        setLoading(true);
        showStatus("", "");
        roleInfo.innerText = "";
        
        const stake = +stakeSelect.value;
        if (myCoins < stake) {
          showStatus("‚ùå Not enough coins.", "error");
          setLoading(false);
          return;
        }

        // Check for existing room
        const roomSnap = await get(ref(db, `rooms/${myUid}`));
        if (roomSnap.exists()) {
          const r = roomSnap.val();
          const result = await Swal.fire({
            title: "Room Exists!",
            text: `You already have a room with ${r.stake} coins stake.`,
            showCancelButton: true,
            confirmButtonText: "Join Room",
            cancelButtonText: "Delete Room",
            icon: "warning"
          });

          if (result.isConfirmed) {
            location.href = `game.html?room=${myUid}&role=home&stake=${r.stake}`;
          } else {
            await remove(ref(db, `rooms/${myUid}`));
            showStatus("‚úÖ Room deleted.", "success");
          }
          setLoading(false);
          return;
        }

        // Create new room
        const roomData = {
          home: myUid,
          away: null,
          stake,
          status: "waiting",
          timer: 0,
          ball: { 
            x: 0.5,  // Using relative coordinates now
            y: 0.5, 
            vx: Math.random() > 0.5 ? 0.005 : -0.005,
            vy: Math.random() > 0.5 ? 0.005 : -0.005, 
            r: 0.02 
          },
          keepers: { 
            homeX: 0.5, 
            homeY: 0.9, 
            awayX: 0.5, 
            awayY: 0.1 
          },
          score: { 
            home: 0, 
            away: 0 
          },
          createdAt: Date.now(),
          players: {
            home: true,
            away: false
          }
        };

        // Start transaction
        await set(ref(db, `rooms/${myUid}`), roomData);
        await update(ref(db, `users/${myUid}`), { 
          coins: myCoins - stake 
        });

        // Setup onDisconnect cleanup
        const playerRef = ref(db, `rooms/${myUid}/players/home`);
        await set(playerRef, true);
        onDisconnect(playerRef).remove();

        showStatus("üïì Waiting for opponent to join...", "");
        roleInfo.innerText = "Role: Home Team (You start the game)";

        // Listen for opponent joining
        if (roomListener) roomListener();
        roomListener = onValue(ref(db, `rooms/${myUid}/away`), (snap) => {
          if (snap.exists() && snap.val() !== null) {
            cleanup();
            location.href = `game.html?room=${myUid}&role=home&stake=${stake}`;
          }
        }, (error) => {
          console.error("Room listener error:", error);
        });

      } catch (error) {
        console.error("Error creating room:", error);
        showStatus("‚ùå Error creating room", "error");
      } finally {
        setLoading(false);
      }
    });

    joinBtn.addEventListener("click", async () => {
      try {
        setLoading(true);
        showStatus("üîç Searching for available rooms...", "loading");
        roleInfo.innerText = "";
        
        const stake = +stakeSelect.value;
        if (myCoins < stake) {
          showStatus("‚ùå Not enough coins.", "error");
          setLoading(false);
          return;
        }

        // Find available room
        const roomsSnap = await get(ref(db, "rooms"));
        const rooms = roomsSnap.val() || {};
        
        let targetRoom = null;
        let targetRoomData = null;
        const now = Date.now();
        const roomExpiryTime = 300000; // 5 minutes
        
        for (const roomId in rooms) {
          const room = rooms[roomId];
          
          // Skip expired rooms
          if (now - (room.createdAt || now) > roomExpiryTime) {
            await remove(ref(db, `rooms/${roomId}`));
            continue;
          }
          
          if (room.status === "waiting" && 
              !room.away && 
              roomId !== myUid) {
            targetRoom = roomId;
            targetRoomData = room;
            break;
          }
        }

        if (!targetRoom) {
          showStatus("‚ùó No available rooms found. Try creating one.", "error");
          setLoading(false);
          return;
        }

        // Join room
        await update(ref(db, `rooms/${targetRoom}`), { 
          away: myUid, 
          status: "playing",
          players: {
            home: true,
            away: true
          },
          ball: { 
            x: 0.5, 
            y: 0.5, 
            vx: Math.random() > 0.5 ? 0.005 : -0.005,
            vy: Math.random() > 0.5 ? 0.005 : -0.005,
            r: 0.02 
          }
        });
        
        // Setup onDisconnect cleanup
        const playerRef = ref(db, `rooms/${targetRoom}/players/away`);
        await set(playerRef, true);
        onDisconnect(playerRef).remove();

        await update(ref(db, `users/${myUid}`), { 
          coins: myCoins - stake 
        });

        cleanup();
        location.href = `game.html?room=${targetRoom}&role=away&stake=${stake}`;

      } catch (error) {
        console.error("Error joining room:", error);
        showStatus("‚ùå Error joining room", "error");
        setLoading(false);
      }
    });

    // Clean up when page unloads
    window.addEventListener("beforeunload", cleanup);
  </script>
<script>
  function rank() {
    window.location.href = 'ranking.html';
  }
</script>
</body>
  </html>
