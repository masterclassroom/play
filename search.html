<!DOCTYPE html>
<html lang="so">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Football Match ‚Äì Matchmaking</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background: #000; color: white; font-family: sans-serif; text-align: center; padding: 20px; max-width: 800px; margin: 0 auto; }
    select, button { font-size: 18px; padding: 12px; margin: 15px auto; width: 100%; max-width: 300px; border-radius: 8px; border: none; cursor: pointer; display: block; }
    #createBtn { background: #28a745; color: white; }
    #joinBtn { background: #007bff; color: white; }
    #coinsDisplay, #statusText, #roleInfo { font-size: 20px; margin: 20px; color: yellow; }
    .loading { color: #aaa; font-style: italic; }
    .error { color: #ff4444; }
    .success { color: #00C851; }
  </style>
</head>
<body>
  <h1>Online Football Match</h1>
  <div id="coinsDisplay">Coins: 0</div>

  <select id="stakeCoins">
    <option value="10">10 Coins</option>
    <option value="20">20 Coins</option>
    <option value="30">30 Coins</option>
    <option value="40">40 Coins</option>
    <option value="50">50 Coins</option>
    <option value="60">60 Coins</option>
    <option value="70">70 Coins</option>
    <option value="80">80 Coins</option>
    <option value="90">90 Coins</option>
    <option value="100">100 Coins</option>
  </select>

  <button id="createBtn">Create Room</button>
  <button id="joinBtn">Join Room</button>

  <div id="statusText"></div>
  <div id="roleInfo"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAj0xbIZhcmWiSf3nYVgIIgTZ_KJ64mTE",
      authDomain: "exam-81b90.firebaseapp.com",
      databaseURL: "https://exam-81b90-default-rtdb.firebaseio.com",
      projectId: "exam-81b90",
      storageBucket: "exam-81b90.appspot.com",
      messagingSenderId: "461178422237",
      appId: "1:461178422237:web:8433ab42b524b0a17bac34",
      measurementId: "G-KKDNZBZLPG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    let myUid = null;
    let myCoins = 0;
    let roomListener = null;

    const stakeSelect = document.getElementById("stakeCoins");
    const coinsDisplay = document.getElementById("coinsDisplay");
    const statusText = document.getElementById("statusText");
    const roleInfo = document.getElementById("roleInfo");
    const createBtn = document.getElementById("createBtn");
    const joinBtn = document.getElementById("joinBtn");

    function updateCoinsDisplay(coins) {
      myCoins = coins;
      coinsDisplay.innerText = `Coins: ${myCoins}`;
    }

    function setLoading(loading) {
      createBtn.disabled = loading;
      joinBtn.disabled = loading;
    }

    function showStatus(message, type = "") {
      statusText.innerText = message;
      statusText.className = type;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "login.html";
        return;
      }
      
      myUid = user.uid;
      
      try {
        const snap = await get(ref(db, `users/${myUid}/coins`));
        updateCoinsDisplay(snap.exists() ? snap.val() : 0);

        onValue(ref(db, `users/${myUid}/coins`), snap => {
          if (snap.exists()) updateCoinsDisplay(snap.val());
        });
      } catch (error) {
        console.error("Error loading user data:", error);
        showStatus("Error loading your data", "error");
      }
    });

    createBtn.addEventListener("click", async () => {
      try {
        setLoading(true);
        showStatus("", "");
        roleInfo.innerText = "";
        
        const stake = +stakeSelect.value;
        if (myCoins < stake) {
          showStatus("‚ùå Not enough coins.", "error");
          return;
        }

        // Check for existing room
        const roomSnap = await get(ref(db, `rooms/${myUid}`));
        if (roomSnap.exists()) {
          const r = roomSnap.val();
          const result = await Swal.fire({
            title: "Room Exists!",
            text: `You already have a room with ${r.stake} coins stake.`,
            showCancelButton: true,
            confirmButtonText: "Join Room",
            cancelButtonText: "Delete Room",
            icon: "warning"
          });

          if (result.isConfirmed) {
            location.href = `game.html?room=${myUid}&role=home&stake=${r.stake}`;
          } else {
            await remove(ref(db, `rooms/${myUid}`));
            showStatus("‚úÖ Room deleted.", "success");
          }
          return;
        }

        // Create new room
        const roomData = {
          home: myUid,
          away: null,
          stake,
          status: "waiting",
          timer: 0, // Will start when game begins
          ball: { 
            x: 200, 
            y: 300, 
            vx: Math.random() > 0.5 ? 2 : -2, // Random initial direction
            vy: Math.random() > 0.5 ? 2 : -2, 
            r: 8 
          },
          keepers: { 
            homeX: 200, 
            homeY: 550, 
            awayX: 200, 
            awayY: 50 
          },
          score: { 
            home: 0, 
            away: 0 
          },
          createdAt: Date.now()
        };

        // Start transaction
        await set(ref(db, `rooms/${myUid}`), roomData);
        await update(ref(db, `users/${myUid}`), { 
          coins: myCoins - stake 
        });
        updateCoinsDisplay(myCoins - stake);

        showStatus("üïì Waiting for opponent to join...", "");
        roleInfo.innerText = "Role: Home Team (You start the game)";

        // Listen for opponent joining
        if (roomListener) roomListener(); // Remove previous listener
        roomListener = onValue(ref(db, `rooms/${myUid}/away`), (snap) => {
          if (snap.exists() && snap.val() !== null) {
            if (roomListener) roomListener();
            location.href = `game.html?room=${myUid}&role=home&stake=${stake}`;
          }
        });

      } catch (error) {
        console.error("Error creating room:", error);
        showStatus("‚ùå Error creating room", "error");
      } finally {
        setLoading(false);
      }
    });

    joinBtn.addEventListener("click", async () => {
      try {
        setLoading(true);
        showStatus("üîç Searching for available rooms...", "loading");
        roleInfo.innerText = "";
        
        const stake = +stakeSelect.value;
        if (myCoins < stake) {
          showStatus("‚ùå Not enough coins.", "error");
          return;
        }

        // Find available room
        const roomsSnap = await get(ref(db, "rooms"));
        const rooms = roomsSnap.val() || {};
        
        let targetRoom = null;
        const now = Date.now();
        const roomExpiryTime = 300000; // 5 minutes
        
        for (const roomId in rooms) {
          const room = rooms[roomId];
          
          // Skip if room is expired
          if (now - (room.createdAt || now) > roomExpiryTime) {
            await remove(ref(db, `rooms/${roomId}`));
            continue;
          }
          
          if (room.status === "waiting" && 
              !room.away && 
              room.stake === stake && 
              roomId !== myUid) {
            targetRoom = roomId;
            break;
          }
        }

        if (!targetRoom) {
          showStatus("‚ùó No available rooms found. Try creating one.", "error");
          return;
        }

        // Join room
        await update(ref(db, `rooms/${targetRoom}`), { 
          away: myUid, 
          status: "playing",
          // Reset ball position when game starts
          ball: { 
            x: 200, 
            y: 300, 
            vx: Math.random() > 0.5 ? 2 : -2,
            vy: Math.random() > 0.5 ? 2 : -2,
            r: 8 
          }
        });
        
        await update(ref(db, `users/${myUid}`), { 
          coins: myCoins - stake 
        });
        updateCoinsDisplay(myCoins - stake);

        location.href = `game.html?room=${targetRoom}&role=away&stake=${stake}`;

      } catch (error) {
        console.error("Error joining room:", error);
        showStatus("‚ùå Error joining room", "error");
      } finally {
        setLoading(false);
      }
    });

    // Clean up when page unloads
    window.addEventListener("beforeunload", () => {
      if (roomListener) roomListener();
    });
  </script>
</body>
</html>