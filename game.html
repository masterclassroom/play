<!DOCTYPE html><html lang="so">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Number Guess Battle</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
  /* Body Styling */
body {
  background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
  color: #fff;
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  padding: 20px;
  user-select: none;
  min-height: 100vh;
  margin: 0;
}

/* Role Title */
#role {
  font-weight: bold;
  color: #ffdd57;
  margin-bottom: 20px;
  font-size: 26px;
  text-shadow: 1px 1px 4px #000;
}

/* Round Text */
#round {
  margin-bottom: 10px;
  font-size: 22px;
  transition: opacity 0.5s ease, transform 0.5s ease;
  opacity: 1;
}

#round.fade {
  opacity: 0;
  transform: scale(0.95);
}

/* Scoreboard */
#scoreboard {
  margin: 20px 0;
  font-size: 24px;
  color: #00ffc6;
  text-shadow: 0 0 5px #00ffc6;
  transition: all 0.3s ease;
}

/* Guess Button Area */
#guessChoices {
  margin-top: 20px;
}

/* Guess Buttons */
#guessChoices button {
  margin: 8px;
  padding: 12px 20px;
  font-size: 22px;
  border-radius: 12px;
  background: #292929;
  color: #fff;
  border: 2px solid #00ffc6;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,255,198,0.2);
  transition: transform 0.2s ease, background 0.3s ease;
}

#guessChoices button:hover {
  background: #00ffc6;
  color: #000;
  transform: scale(1.1);
}

/* Profile Container */
.profile {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 40px;
  margin: 30px 0;
}

/* Each Profile Box */
.profileBox {
  text-align: center;
  background: rgba(255, 255, 255, 0.05);
  padding: 10px 20px;
  border-radius: 16px;
  box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
  transition: transform 0.3s ease;
}

.profileBox:hover {
  transform: scale(1.05);
}

/* Profile Image */
.profileBox img {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  border: 3px solid #00ffc6;
  box-shadow: 0 0 10px #00ffc6;
  transition: box-shadow 0.3s ease;
}

/* Profile Name */
.profileBox p {
  margin-top: 10px;
  font-size: 18px;
  font-weight: bold;
}

/* Score Animation */
@keyframes pop {
  0% { transform: scale(1); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

.score-animate {
  animation: pop 0.4s ease;
}
  </style>
 
</head>
<body>  
  <div id="role">Loading role...</div>
  <div id="round">Round: 1 / 5</div>
  <div class="profile">
    <div class="profileBox">
      <img id="homeProfile" src="" alt="Home Profile">
      <p id="homeName"></p>
    </div>
    <div class="profileBox">
      <img id="awayProfile" src="" alt="Away Profile">
      <p id="awayName"></p>
    </div>
  </div>
  <div id="scoreboard">Home: 0 | Away: 0</div>
  <div id="guessChoices" style="display: none;"></div>  
<script src="g.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, update, get, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAj0xbIZhcmWiSf3nYVgIIgTZ_KJ64mTE",
      authDomain: "exam-81b90.firebaseapp.com",
      databaseURL: "https://exam-81b90-default-rtdb.firebaseio.com",
      projectId: "exam-81b90",
      storageBucket: "exam-81b90.appspot.com",
      messagingSenderId: "461178422237",
      appId: "1:461178422237:web:8433ab42b524b0a17bac34"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const urlParams = new URLSearchParams(location.search);
    const roomId = urlParams.get("room");
    const role = urlParams.get("role");

    const roleEl = document.getElementById("role");
    const roundEl = document.getElementById("round");
    const scoreboardEl = document.getElementById("scoreboard");
    const guessChoices = document.getElementById("guessChoices");
    const homeProfile = document.getElementById("homeProfile");
    const awayProfile = document.getElementById("awayProfile");
    const homeName = document.getElementById("homeName");
    const awayName = document.getElementById("awayName");

    let myUid = null;
    let round = 1;
    const maxRounds = 5;
    let scoreHome = 0;
    let scoreAway = 0;
    let lastSeenRound = 0;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "login.html";
      myUid = user.uid;
      if (!roomId || !role) return location.href = "home.html";

      roleEl.innerText = `Role: ${role}`;

      const roomRef = ref(db, `rooms/${roomId}`);
      const roomSnap = await get(roomRef);
      if (!roomSnap.exists()) return location.href = "room.html";
      const roomData = roomSnap.val();

      // Security: Check if current user is part of the room
      if ((role === "home" && roomData.home !== myUid) || (role === "away" && roomData.away !== myUid)) {
        await Swal.fire("You are not part of this game", "Redirecting to home...", "warning");
        return location.href = "home.html";
      }

      // Load profiles
      const homeSnap = await get(ref(db, `users/${roomData.home}`));
      const awaySnap = await get(ref(db, `users/${roomData.away}`));
      if (homeSnap.exists()) {
        const home = homeSnap.val();
        homeProfile.src = home.logo ? `./${home.logo}.png` : "default.png";
        homeName.innerText = home.username || "Home";
      }
      if (awaySnap.exists()) {
        const away = awaySnap.val();
        awayProfile.src = away.logo ? `./${away.logo}.png` : "default.png";
        awayName.innerText = away.username || "Away";
      }

      onValue(roomRef, async snap => {
        if (!snap.exists()) return location.href = "room.html";

        const data = snap.val();

        if (!data.round) {
          await update(roomRef, { round: 1, score: { home: 0, away: 0 } });
          return;
        }

        if (data.round !== round) {
          round = data.round;
          roundEl.classList.add("fade");
          await new Promise(r => setTimeout(r, 500));
          roundEl.innerText = `Round: ${round} / ${maxRounds}`;
          roundEl.classList.remove("fade");
        }

        if (data.score) {
          scoreHome = data.score.home || 0;
          scoreAway = data.score.away || 0;
          scoreboardEl.innerText = `Home: ${scoreHome} | Away: ${scoreAway}`;
        }

        if (!data[`${role}Guess`] && round <= maxRounds) {
          showGuessChoices();
        } else {
          guessChoices.style.display = "none";
        }

        // Only home creates target and calculates round result
        if (
          role === "home" &&
          data.homeGuess && data.awayGuess &&
          data.round === round &&
          (!data.lastResult || data.lastResult.round !== round)
        ) {
          const target = Math.floor(Math.random() * 10) + 1;
          const diffHome = Math.abs(data.homeGuess.value - target);
          const diffAway = Math.abs(data.awayGuess.value - target);

          let winner = null;
          if (diffHome < diffAway) winner = "home";
          else if (diffAway < diffHome) winner = "away";

          await update(roomRef, {
            lastResult: {
              round,
              winner,
              target,
              home: data.homeGuess.value,
              away: data.awayGuess.value
            },
            score: {
              home: scoreHome + (winner === "home" ? 1 : 0),
              away: scoreAway + (winner === "away" ? 1 : 0)
            },
            round: round + 1,
            homeGuess: null,
            awayGuess: null
          });
        }

        if (data.lastResult && data.lastResult.round !== lastSeenRound) {
          lastSeenRound = data.lastResult.round;
          const result = data.lastResult;
          let msg = `üéØ Target: ${result.target}\nHome: ${result.home} | Away: ${result.away}`;
          let title = result.winner ? `${result.winner.toUpperCase()} Wins the Round!` : "It's a Draw!";

          await Swal.fire({ title, text: msg, icon: result.winner ? "success" : "info" });
        }

        if (round > maxRounds) {
          document.querySelectorAll("#guessChoices button").forEach(btn => btn.disabled = true);
          setTimeout(() => {
  endGame();
}, 2000);
        }
      });
    });

    function showGuessChoices() {
      guessChoices.innerHTML = "<p>Choose a number (1-10):</p>";
      for (let i = 1; i <= 10; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.onclick = () => selectGuess(i);
        guessChoices.appendChild(btn);
      }
      guessChoices.style.display = "block";
    }

    async function selectGuess(val) {
      guessChoices.style.display = "none";
      await update(ref(db, `rooms/${roomId}`), {
        [`${role}Guess`]: { uid: myUid, value: val }
      });
    }
let gameEnded = false;

async function endGame() {
  if (gameEnded) return;
  gameEnded = true;

  const roomRef = ref(db, `rooms/${roomId}`);
  const roomSnap = await get(roomRef);
  if (!roomSnap.exists()) return;

  const roomData = roomSnap.val();
  const homeUid = roomData.home;
  const awayUid = roomData.away;
  const stake = roomData.stake || 10;
  const roomType = roomData.type || "normal"; // default to normal
  const isFriendMatch = roomType === "friendmatch";

  let winner = null;
  if (scoreHome > scoreAway) winner = "home";
  else if (scoreAway > scoreHome) winner = "away";
  const isDraw = winner === null;

  // ‚úÖ Step 1: Show final result via SweetAlert

  // ‚úÖ Step 2: Update stats if NOT friendmatch
  if (!isFriendMatch) {
    const homeStatsRef = ref(db, `users/${homeUid}/stats`);
    const awayStatsRef = ref(db, `users/${awayUid}/stats`);

    try {
      const [homeSnap, awaySnap] = await Promise.all([
        get(homeStatsRef),
        get(awayStatsRef)
      ]);

      const homeStats = homeSnap.exists() ? homeSnap.val() : {
        played: 0, wins: 0, losses: 0, draws: 0, coins: 0, totalcoinswon: 0
      };
      const awayStats = awaySnap.exists() ? awaySnap.val() : {
        played: 0, wins: 0, losses: 0, draws: 0, coins: 0, totalcoinswon: 0
      };

      // Update played
      homeStats.played += 1;
      awayStats.played += 1;

      if (winner === "home") {
        homeStats.wins += 1;
        homeStats.coins += stake * 2;
        homeStats.totalcoinswon += stake * 2;
        awayStats.losses += 1;
      } else if (winner === "away") {
        awayStats.wins += 1;
        awayStats.coins += stake * 2;
        awayStats.totalcoinswon += stake * 2;
        homeStats.losses += 1;
      } else {
        homeStats.draws += 1;
        awayStats.draws += 1;
      }

      await Promise.all([
        update(homeStatsRef, homeStats),
        update(awayStatsRef, awayStats)
      ]);
    } catch (err) {
      console.error("‚ö†Ô∏è Stats update error:", err);
    }
  }

  // ‚úÖ Step 3: Redirect to endgame page
  const endParams = new URLSearchParams({
    room: roomId,
    role,
    type: roomType,
    winner: isDraw ? "draw" : winner,
    scoreHome,
    scoreAway
  });

  location.href = `endgame.html?${endParams.toString()}`;
}

  </script>
</body>
</html>