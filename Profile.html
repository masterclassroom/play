<!DOCTYPE html>
<html lang="so">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Profile</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: white;
      text-align: center;
      padding: 30px;
    }
    .profile-card {
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      margin: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }
    .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #00cec9;
      margin-bottom: 10px;
      cursor: default;
    }
    h2 {
      margin: 10px 0;
    }
    .stat {
      margin: 8px 0;
      font-size: 18px;
    }
    button {
      margin: 10px 5px;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      border: none;
      cursor: pointer;
      color: white;
      background-color: #0984e3;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #74b9ff;
    }
    #sendRequestBtn { background-color: #00b894; }
    #sendRequestBtn:hover { background-color: #00cec9; }
    #messageBtn { background-color: #6c5ce7; }
    #messageBtn:hover { background-color: #a29bfe; }
    #followBtn {
      background-color: #fd79a8;
      display: none;
      margin-top: 10px;
    }
    #followBtn:hover { background-color: #e84393; }
    #sendGiftBtn {
      background-color: #fdcb6e;
      display: none;
    }
    #sendGiftBtn:hover {
      background-color: #ffeaa7;
      color: black;
    }
    #avatarOptions {
      margin-top: 20px;
      display: none;
      justify-content: center;
      gap: 15px;
    }
    #avatarOptions img {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.3s;
    }
    #avatarOptions img:hover {
      border-color: #00cec9;
    }
    .info-toggle {
      color: #74b9ff;
      cursor: pointer;
      text-decoration: underline;
      margin: 10px 0;
      display: inline-block;
    }
    .hidden-info {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }
    .hidden-info a {
      display: block;
      margin: 5px 0;
      color: white;
      text-decoration: none;
    }
    .hidden-info a:hover {
      text-decoration: underline;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <div class="profile-card" id="profileCard">
    <img src="avatars/default.png" alt="Avatar" class="avatar" id="avatarImg" title="User Avatar" />
    <div id="avatarOptions">
      <img src="avatars/avatar1.png" data-avatar="Somaliland" alt="Somaliland">
      <img src="avatars/avatar2.png" data-avatar="Somalia" alt="Somalia">
      <img src="avatars/avatar3.png" data-avatar="Djibouti" alt="Djibouti">
      <img src="avatars/avatar4.png" data-avatar="Ethiopia" alt="Ethiopia">
      <img src="avatars/avatar5.png" data-avatar="Uganda" alt="Uganda">
      <img src="avatars/avatar6.png" data-avatar="Kenya" alt="Kenya">
      <img src="avatars/default.png" data-avatar="default" alt="default">
    </div>
    <h2 id="usernameText">Loading...</h2>
    <div class="stat" id="winsText">Wins: 0</div>
    <div class="stat" id="playedText">Played: 0</div>
    <div class="stat" id="lossesText">Losses: 0</div>
    <div class="stat" id="coinsText">Coins Won: 0</div>
    <div class="stat" id="followersText">Followers: 0</div>

    <!-- Toggle for About and Social Links -->
    <div class="info-toggle" id="toggleInfoBtn">‚ñº Show Profile Info</div>
    <div class="hidden-info" id="profileInfo">
      <div id="aboutSection"></div>
      <div id="socialLinks"></div>
    </div>

    <button id="sendRequestBtn">Send Friend Request</button>
    <button id="messageBtn" style="display: none;">Message</button>
    <button id="followBtn">Follow</button>
    <button id="sendGiftBtn">üéÅ Send Gift</button>
    <button id="myFriendsBtn">My Friends</button>
    <button class="back-btn" onclick="history.back()">‚¨ÖÔ∏è Back</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, update, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAj0xbIZhcmWiSf3nYVgIIgTZ_KJ64mTE",
      authDomain: "exam-81b90.firebaseapp.com",
      databaseURL: "https://exam-81b90-default-rtdb.firebaseio.com",
      projectId: "exam-81b90",
      storageBucket: "exam-81b90.appspot.com",
      messagingSenderId: "461178422237",
      appId: "1:461178422237:web:8433ab42b524b0a17bac34"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const uidParam = new URLSearchParams(location.search).get("uid");

    const avatarImg = document.getElementById("avatarImg");
    const avatarOptions = document.getElementById("avatarOptions");
    const usernameText = document.getElementById("usernameText");
    const winsText = document.getElementById("winsText");
    const playedText = document.getElementById("playedText");
    const lossesText = document.getElementById("lossesText");
    const coinsText = document.getElementById("coinsText");
    const followersText = document.getElementById("followersText");
    const toggleInfoBtn = document.getElementById("toggleInfoBtn");
    const profileInfo = document.getElementById("profileInfo");
    const aboutSection = document.getElementById("aboutSection");
    const socialLinks = document.getElementById("socialLinks");

    const sendRequestBtn = document.getElementById("sendRequestBtn");
    const messageBtn = document.getElementById("messageBtn");
    const myFriendsBtn = document.getElementById("myFriendsBtn");
    const followBtn = document.getElementById("followBtn");
    const sendGiftBtn = document.getElementById("sendGiftBtn");
    const profileCard = document.getElementById("profileCard");

    let currentUserUid = null;
    let profileUserUid = uidParam;
    let isCurrentUser = false;
    let friendsList = [];
    let isFollowing = false;
    let infoVisible = false;

    // Toggle profile info visibility
    toggleInfoBtn.addEventListener("click", () => {
      infoVisible = !infoVisible;
      profileInfo.style.display = infoVisible ? "block" : "none";
      toggleInfoBtn.textContent = infoVisible ? "‚ñ≤ Hide Profile Info" : "‚ñº Show Profile Info";
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        await Swal.fire("Please login first");
        location.href = "login.html";
        return;
      }

      currentUserUid = user.uid;

      followersText.style.cursor = "pointer";
      followersText.style.textDecoration = "underline";
      followersText.addEventListener("click", () => {
        window.location.href = `followers.html?uid=${profileUserUid}`;
      });

      if (!profileUserUid) {
        await Swal.fire("User ID missing");
        return;
      }

      isCurrentUser = currentUserUid === profileUserUid;

      const userRef = ref(db, `users/${profileUserUid}`);
      const userSnap = await get(userRef);
      if (!userSnap.exists()) {
        await Swal.fire("User not found");
        return;
      }
      const userData = userSnap.val();
      const stats = userData.stats || {};
      const logo = userData.logo || "default";

      avatarImg.src = `${logo}.png`;
      usernameText.innerText = userData.username || "Unknown";
      winsText.innerText = `Wins: ${stats.wins || 0}`;
      playedText.innerText = `Played: ${stats.played || 0}`;
      lossesText.innerText = `Losses: ${stats.losses || 0}`;
      coinsText.innerText = `Coins Won: ${stats.totalcoinswon || 0}`;

      // Show about if exists
      if (userData.about) {
        aboutSection.innerHTML = `<p style="margin: 15px 0; font-style: italic;">"${userData.about}"</p>`;
      } else {
        aboutSection.innerHTML = isCurrentUser 
          ? '<p style="font-style: italic; color: #aaa;">No about info yet. <button onclick="document.getElementById(\'editAboutBtn\').click()">Add one</button></p>'
          : '<p style="font-style: italic; color: #aaa;">No about info</p>';
      }

      // Show social links
      const links = userData.links || {};
      if (links.youtube || links.facebook || links.whatsapp) {
        let linksHTML = '<div style="margin-top: 10px;">';
        
        if (links.youtube) {
          linksHTML += `<a href="${links.youtube}" target="_blank" style="display: block; color: #fab1a0; margin: 5px 0;">üì∫ YouTube</a>`;
        }
        if (links.facebook) {
          linksHTML += `<a href="${links.facebook}" target="_blank" style="display: block; color: #74b9ff; margin: 5px 0;">üìò Facebook</a>`;
        }
        if (links.whatsapp) {
          const url = `https://wa.me/${links.whatsapp.number.replace(/\D/g, "")}?text=${encodeURIComponent(links.whatsapp.msg)}`;
          linksHTML += `<a href="${url}" target="_blank" style="display: block; color: #55efc4; margin: 5px 0;">üí¨ WhatsApp</a>`;
        }
        
        linksHTML += '</div>';
        socialLinks.innerHTML = linksHTML;
      } else {
        socialLinks.innerHTML = isCurrentUser 
          ? '<p style="color: #aaa;">No social links. <button onclick="document.getElementById(\'editSocialBtn\').click()">Add some</button></p>'
          : '<p style="color: #aaa;">No social links</p>';
      }

      // Friends check
      const friendsRef = ref(db, `friends/${currentUserUid}`);
      const friendsSnap = await get(friendsRef);
      friendsList = friendsSnap.exists() ? Object.keys(friendsSnap.val()) : [];

      // Friend request check
      const requestRef = ref(db, `friendRequests/${profileUserUid}/${currentUserUid}`);
      const requestSnap = await get(requestRef);
      const alreadyRequested = requestSnap.exists();

      const followersRef = ref(db, `followers/${profileUserUid}`);
      onValue(followersRef, (snapshot) => {
        const followersData = snapshot.val() || {};
        const followerCount = 7Object.keys(followersData).length;
        followersText.innerText = `Followers: ${followerCount}`;
        isFollowing = currentUserUid in followersData;

        followBtn.style.display = isCurrentUser ? "none" : "inline-block";
        followBtn.innerText = isFollowing ? "Unfollow" : "Follow";
      });

      if (isCurrentUser) {
        sendRequestBtn.style.display = "none";
        messageBtn.style.display = "none";
        sendGiftBtn.style.display = "none";

        // Edit About button
        const editAboutBtn = document.createElement("button");
        editAboutBtn.id = "editAboutBtn";
        editAboutBtn.innerText = "‚úçÔ∏è Edit About";
        profileCard.appendChild(editAboutBtn);
        editAboutBtn.onclick = async () => {
          const { value: about } = await Swal.fire({
            title: "Your About",
            input: "textarea",
            inputValue: userData.about || "",
            showCancelButton: true,
          });
          if (about !== undefined) {
            await update(userRef, { about });
            aboutSection.innerHTML = `<p style="margin: 15px 0; font-style: italic;">"${about}"</p>`;
            Swal.fire("About updated");
          }
        };

        // Edit Social Links
        const editSocialBtn = document.createElement("button");
        editSocialBtn.id = "editSocialBtn";
        editSocialBtn.innerText = "üåê Edit Social Links";
        profileCard.appendChild(editSocialBtn);
        editSocialBtn.onclick = async () => {
          const { value: platform } = await Swal.fire({
            title: "Choose platform",
            input: "select",
            inputOptions: {
              youtube: "YouTube",
              facebook: "Facebook",
              whatsapp: "WhatsApp"
            },
            inputPlaceholder: "Select platform",
            showCancelButton: true,
          });

          if (!platform) return;

          if (platform === "whatsapp") {
            const { value: action } = await Swal.fire({
              title: "WhatsApp Number",
              input: "radio",
              inputOptions: {
                use: `Use this phone (${userData.number || "Not set"})`,
                new: "Add another number"
              },
              inputValidator: v => !v && "Choose one"
            });

            let number = userData.number;
            if (action === "new") {
              const { value: newNumber } = await Swal.fire({
                title: "Enter Number",
                input: "text",
                inputLabel: "Include country code (e.g. +25261xxxxxx)",
                inputPlaceholder: "+25261xxxxxx",
                inputValidator: value => {
                  if (!value) return "Required";
                  if (!value.startsWith("+") || value.replace(/\D/g, "").length < 10) return "Invalid number";
                  return null;
                }
              });
              number = newNumber;
            }

            const { value: msg } = await Swal.fire({
              title: "Enter Message",
              input: "text",
              inputPlaceholder: "e.g., Hello!",
              inputValidator: val => !val ? "Required" : null
            });

            if (number && msg) {
              await update(userRef, {
                links: { ...links, whatsapp: { number, msg } }
              });
              const url = `https://wa.me/${number.replace(/\D/g, "")}?text=${encodeURIComponent(msg)}`;
              socialLinks.innerHTML = `<div style="margin-top: 10px;"><a href="${url}" target="_blank" style="display: block; color: #55efc4; margin: 5px 0;">üí¨ WhatsApp</a></div>`;
              Swal.fire("WhatsApp saved!");
            }

          } else {
            const { value: link } = await Swal.fire({
              title: `Enter ${platform} link`,
              input: "url",
              inputPlaceholder: `https://${platform}.com/yourprofile`,
              inputValidator: value => {
                if (!value) return "Required";
                if (
                  platform === "youtube" &&
                  !value.startsWith("https://www.youtube.com/") &&
                  !value.startsWith("https://youtube.com/")
                ) {
                  return "Only valid YouTube links allowed";
                }
                if (
                  platform === "facebook" &&
                  !value.startsWith("https://www.facebook.com/") &&
                  !value.startsWith("https://facebook.com/")
                ) {
                  return "Only valid Facebook links allowed";
                }
                return null;
              }
            });

            if (link) {
              await update(userRef, {
                links: { ...links, [platform]: link }
              });
              
              // Update the displayed link
              let linkHTML = socialLinks.innerHTML;
              if (linkHTML.includes('No social links')) {
                linkHTML = '<div style="margin-top: 10px;">';
              } else {
                linkHTML = linkHTML.replace('</div>', '');
              }
              
              const icon = platform === "youtube" ? "üì∫" : "üìò";
              const color = platform === "youtube" ? "#fab1a0" : "#74b9ff";
              linkHTML += `<a href="${link}" target="_blank" style="display: block; color: ${color}; margin: 5px 0;">${icon} ${platform.charAt(0).toUpperCase() + platform.slice(1)}</a></div>`;
              socialLinks.innerHTML = linkHTML;
              
              Swal.fire(`${platform} link saved!`);
            }
          }
        };

        avatarImg.addEventListener("click", () => {
          avatarOptions.style.display = avatarOptions.style.display === "flex" ? "none" : "flex";
        });

        avatarOptions.querySelectorAll("img").forEach(img => {
          img.addEventListener("click", async () => {
            const selectedAvatar = img.getAttribute("data-avatar");
            await update(userRef, { logo: selectedAvatar });
            avatarImg.src = `${selectedAvatar}.png`;
            avatarOptions.style.display = "none";
            Swal.fire("Avatar updated");
          });
        });
      } else if (friendsList.includes(profileUserUid)) {
        sendRequestBtn.style.display = "none";
        messageBtn.style.display = "inline-block";
        sendGiftBtn.style.display = "inline-block";
        messageBtn.onclick = () => location.href = `chat.html?uid=${profileUserUid}`;
        sendGiftBtn.onclick = () => location.href = `sendgift.html?user=${profileUserUid}`;
      } else if (!alreadyRequested) {
        sendRequestBtn.style.display = "inline-block";
      }
    });

    sendRequestBtn.addEventListener("click", async () => {
      const requestRef = ref(db, `friendRequests/${profileUserUid}/${currentUserUid}`);
      await update(requestRef, {
        status: "pending",
        from: currentUserUid,
        timestamp: Date.now()
      });
      sendRequestBtn.style.display = "none";
      Swal.fire("Request sent");
    });

    followBtn.addEventListener("click", async () => {
      const followerRef = ref(db, `followers/${profileUserUid}/${currentUserUid}`);
      if (isFollowing) {
        await remove(followerRef);
        Swal.fire("Unfollowed");
      } else {
        await set(followerRef, true);
        Swal.fire("Followed");
      }
    });

    myFriendsBtn.addEventListener("click", () => {
      location.href = "friends.html";
    });
  </script>
</body>
</html>