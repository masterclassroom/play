<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile</title>
  <style>
    :root {
      --primary: #3498db;
      --secondary: #2ecc71;
      --accent: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --gray: #95a5a6;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }
    
    .profile-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
      position: relative;
    }
    
    .profile-header {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  height: 160px; /* kor u qaaday */
  position: relative;
  padding-top: 100px; /* si avatar-ka uusan u noqon cidlo */
  overflow: visible; /* muhiim si avatar-ka uusan u go'in */
}
    
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid white;
      object-fit: cover;
      position: absolute;
      top: 10px; /* Changed from bottom to top */
      left: 50%;
      transform: translateX(-50%);
      background: #ddd;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 3;
    }
    
    .profile-name-container {
      position: relative;
      width: 100%;
      text-align: center;
      z-index: 2;
      margin-top: 20px;
    }
    
    .profile-name {
      font-size: 24px;
      font-weight: 600;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      cursor: pointer;
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      transition: background-color 0.3s;
    }
    
    .profile-name:hover {
      background-color: rgba(255,255,255,0.2);
    }
    
    .profile-body {
      padding: 20px;
      text-align: center;
    }
    
    .profile-bio {
      color: var(--gray);
      margin-bottom: 20px;
      font-style: italic;
    }
    
    .profile-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .stat-item {
      text-align: center;
      min-width: 80px;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--gray);
    }
    
    .profile-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 5px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #2980b9;
    }
    
    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    
    .btn-secondary:hover {
      background: #27ae60;
    }
    
    .btn-accent {
      background: var(--accent);
      color: white;
    }
    
    .btn-accent:hover {
      background: #c0392b;
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--gray);
      color: var(--dark);
    }
    
    .btn-outline:hover {
      background: #f0f0f0;
    }
    
    .profile-details {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .social-links {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 15px;
    }
    
    .social-link {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--dark);
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 5px;
      background: #eee;
      transition: all 0.3s;
    }
    
    .social-link:hover {
      background: #e0e0e0;
      transform: translateY(-2px);
    }
    
    .back-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(255,255,255,0.8);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* Modal styles for avatar selection */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    
    .radio-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .radio-option:hover {
      background: #f5f5f5;
    }
    
    .radio-option img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    @media (max-width: 600px) {
      .profile-stats {
        gap: 10px;
      }
      
      .profile-actions {
        flex-direction: column;
        align-items: center;
      }
      
      .btn {
        width: 100%;
        max-width: 250px;
        justify-content: center;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <div class="profile-card">
     
      <div class="profile-header">
        <img src="avatars/default.png" alt="Avatar" class="profile-avatar" id="avatarImg">
        
        <div class="profile-name-container">
          <h1 class="profile-name" id="usernameText">Loading...</h1>
        </div>
      </div>
      
      <div class="profile-body">
        <p class="profile-bio" id="aboutText">No bio yet</p>
        
        <div class="profile-stats">
          <div class="stat-item">
            <div class="stat-value" id="winsText">0</div>
            <div class="stat-label">Wins</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="playedText">0</div>
            <div class="stat-label">Played</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="lossesText">0</div>
            <div class="stat-label">Losses</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="coinsText">0</div>
            <div class="stat-label">Coins won</div>
          </div>
          <div class="stat-item" id="followersItem" style="cursor: pointer;">
            <div class="stat-value" id="followersText">0</div>
            <div class="stat-label">Followers</div>
          </div>
        </div>
        
        <div class="profile-actions">
          <button class="btn btn-primary" id="sendRequestBtn">
            <i class="fas fa-user-plus"></i> Add Friend
          </button>
          <button class="btn btn-secondary" id="messageBtn" style="display: none;">
            <i class="fas fa-envelope"></i> Message
          </button>
          <button class="btn btn-accent" id="followBtn" style="display: none;">
            <i class="fas fa-user-plus"></i> Follow
          </button>
          <button class="btn btn-outline" id="sendGiftBtn" style="display: none;">
            <i class="fas fa-gift"></i> Send Gift
          </button>
          <button class="btn btn-outline" id="myFriendsBtn">
            <i class="fas fa-users"></i> My Friends
          </button>
        </div>
        
        <div class="profile-details">
          <h3 class="section-title">Social Links</h3>
          <div class="social-links" id="socialLinks">
            <p style="color: #aaa;">No social links</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Current Photos Modal -->
  <div class="modal" id="currentPhotosModal">
    <div class="modal-content">
      <h3>Select Profile Picture</h3>
      <p>Choose one of our current photos:</p>
      
      <div class="radio-options">
        <label class="radio-option">
          <input type="radio" name="avatarOption" value="default" checked>
          <img src="default.png" alt="default">
          <span>default</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="avatarOption" value="Uganda" checked>
          <img src="Uganda.png" alt="Uganda">
          <span>Uganda</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="avatarOption" value="Somaliland">
          <img src="Somaliland.png" alt="Somaliland">
          <span>Somaliland</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="avatarOption" value="Somalia">
          <img src="Somalia.png" alt="Somalia">
          <span>Somalia</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="avatarOption" value="Ethiopia">
          <img src="Ethiopia.png" alt="Ethiopia">
          <span>Ethiopia</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="avatarOption" value="Kenya">
          <img src="Kenya.png" alt="Kenya">
          <span>Kenya</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="avatarOption" value="Djibouti">
          <img src="Djibouti.png" alt="Djibouti">
          <span>Djibouti</span>
        </label>
      </div>
      
      <button class="btn btn-primary" id="saveCurrentPhoto">
        Save Photo
      </button>
      <button class="btn btn-outline" id="cancelCurrentPhoto">
        Cancel
      </button>
    </div>
  </div>        
     

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, update, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAj0xbIZhcmWiSf3nYVgIIgTZ_KJ64mTE",
      authDomain: "exam-81b90.firebaseapp.com",
      databaseURL: "https://exam-81b90-default-rtdb.firebaseio.com",
      projectId: "exam-81b90",
      storageBucket: "exam-81b90.appspot.com",
      messagingSenderId: "461178422237",
      appId: "1:461178422237:web:8433ab42b524b0a17bac34"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const uidParam = new URLSearchParams(location.search).get("uid");

    // DOM Elements
    const avatarImg = document.getElementById("avatarImg");
    const usernameText = document.getElementById("usernameText");
    const aboutText = document.getElementById("aboutText");
    const winsText = document.getElementById("winsText");
    const playedText = document.getElementById("playedText");
    const lossesText = document.getElementById("lossesText");
    const coinsText = document.getElementById("coinsText");
    const followersText = document.getElementById("followersText");
    const followersItem = document.getElementById("followersItem");
    const socialLinks = document.getElementById("socialLinks");

    const sendRequestBtn = document.getElementById("sendRequestBtn");
    const messageBtn = document.getElementById("messageBtn");
    const followBtn = document.getElementById("followBtn");
    const sendGiftBtn = document.getElementById("sendGiftBtn");
    const myFriendsBtn = document.getElementById("myFriendsBtn");

    // Modal elements
    const currentPhotosModal = document.getElementById("currentPhotosModal");
    const cancelCurrentPhoto = document.getElementById("cancelCurrentPhoto");
    const saveCurrentPhoto = document.getElementById("saveCurrentPhoto");

    let currentUserUid = null;
    let profileUserUid = uidParam;
    let isCurrentUser = false;
    let friendsList = [];
    let isFollowing = false;

    // Initialize the profile
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        await Swal.fire("Please login first");
        location.href = "login.html";
        return;
      }

      currentUserUid = user.uid;

      // Set up followers click handler
      followersItem.addEventListener("click", () => {
        window.location.href = `followers.html?uid=${profileUserUid}`;
      });

      if (!profileUserUid) {
        await Swal.fire("User ID missing");
        return;
      }

      isCurrentUser = currentUserUid === profileUserUid;

      const userRef = ref(db, `users/${profileUserUid}`);
      const userSnap = await get(userRef);
      if (!userSnap.exists()) {
        await Swal.fire("User not found");
        return;
      }
      
      const userData = userSnap.val();
      const stats = userData.stats || {};
      const logo = userData.logo || "default";

      // Update profile info
      avatarImg.src = `${logo}.png`;
      usernameText.innerText = userData.username || "Unknown";
      aboutText.innerText = userData.about || (isCurrentUser ? "Click to add your bio" : "No bio yet");
      winsText.innerText = stats.wins || 0;
      playedText.innerText = stats.played || 0;
      lossesText.innerText = stats.losses || 0;
      coinsText.innerText = stats.totalcoinswon || 0;

      // Update social links
      updateSocialLinks(userData.links || {});

      // Friends check
      const friendsRef = ref(db, `friends/${currentUserUid}`);
      const friendsSnap = await get(friendsRef);
      friendsList = friendsSnap.exists() ? Object.keys(friendsSnap.val()) : [];

      // Friend request check
      const requestRef = ref(db, `friendRequests/${profileUserUid}/${currentUserUid}`);
      const requestSnap = await get(requestRef);
      const alreadyRequested = requestSnap.exists();

      // Followers setup
      const followersRef = ref(db, `followers/${profileUserUid}`);
      onValue(followersRef, (snapshot) => {
        const followersData = snapshot.val() || {};
        const followerCount = Object.keys(followersData).length;
        followersText.innerText = followerCount;
        isFollowing = currentUserUid in followersData;

        followBtn.style.display = isCurrentUser ? "none" : "inline-block";
        followBtn.innerHTML = isFollowing 
          ? `<i class="fas fa-user-minus"></i> Unfollow` 
          : `<i class="fas fa-user-plus"></i> Follow`;
      });

      // Handle current user specific features
      if (isCurrentUser) {
        sendRequestBtn.style.display = "none";
        messageBtn.style.display = "none";
        sendGiftBtn.style.display = "none";

        // Make bio editable
        aboutText.style.cursor = "pointer";
        aboutText.addEventListener("click", async () => {
          const { value: newBio } = await Swal.fire({
            title: "Edit Your Bio",
            input: "textarea",
            inputValue: userData.about || "",
            showCancelButton: true,
            inputValidator: (value) => {
              if (value && value.length > 30) {
                return "Bio must be less than 30 characters";
              }
              return null;
            }
          });
          
          if (newBio !== undefined) {
            await update(userRef, { about: newBio });
            aboutText.innerText = newBio || "Click to add your bio";
            Swal.fire("Bio updated!");
          }
        });

        // Make username editable
        usernameText.style.cursor = "pointer";
        usernameText.addEventListener("click", async () => {
          const { value: newUsername } = await Swal.fire({
            title: "Change Username",
            input: "text",
            inputValue: userData.username || "",
            showCancelButton: true,
            inputValidator: (value) => {
              if (!value) return "Username is required";
              if (value.length < 3) return "Username must be at least 3 characters";
              if (value.length > 20) return "Username must be less than 20 characters";
              return null;
            }
          });
          
          if (newUsername !== undefined) {
            await update(userRef, { username: newUsername });
            usernameText.innerText = newUsername;
            Swal.fire("Username updated!");
          }
        });

        // Make avatar clickable to show current photos modal
        avatarImg.addEventListener("click", () => {
          currentPhotosModal.style.display = "flex";
        });

        // Add edit social links button
        const editSocialBtn = document.createElement("button");
        editSocialBtn.className = "btn btn-outline";
        editSocialBtn.innerHTML = `<i class="fas fa-edit"></i> Edit Links`;
        editSocialBtn.style.marginTop = "10px";
        editSocialBtn.addEventListener("click", () => editSocialLinks(userData.links || {}));
        socialLinks.parentNode.insertBefore(editSocialBtn, socialLinks.nextSibling);
      } 
      // Handle friend/follow buttons for other users
      else {
        if (friendsList.includes(profileUserUid)) {
          sendRequestBtn.style.display = "none";
          messageBtn.style.display = "inline-block";
          sendGiftBtn.style.display = "inline-block";
          messageBtn.onclick = () => location.href = `chat.html?uid=${profileUserUid}`;
          sendGiftBtn.onclick = () => location.href = `sendgift.html?user=${profileUserUid}`;
        } else if (!alreadyRequested) {
          sendRequestBtn.style.display = "inline-block";
        }
      }
    });

    // Handle current photo selection
    saveCurrentPhoto.addEventListener('click', async () => {
      const selectedAvatar = document.querySelector('input[name="avatarOption"]:checked').value;
      const userRef = ref(db, `users/${currentUserUid}`);
      
      await update(userRef, { logo: selectedAvatar });
      avatarImg.src = `${selectedAvatar}.png`;
      
      Swal.fire('Avatar updated!');
      currentPhotosModal.style.display = 'none';
    });

    cancelCurrentPhoto.addEventListener("click", () => {
      currentPhotosModal.style.display = "none";
    });

    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
      if (event.target === currentPhotosModal) {
        currentPhotosModal.style.display = 'none';
      }
    });

    // Update social links display
    function updateSocialLinks(links) {
      if (links.youtube || links.facebook || links.whatsapp) {
        let linksHTML = '';
        
        if (links.youtube) {
          linksHTML += `
            <a href="${links.youtube}" target="_blank" class="social-link">
              <i class="fab fa-youtube"></i> YouTube
            </a>
          `;
        }
        if (links.facebook) {
          linksHTML += `
            <a href="${links.facebook}" target="_blank" class="social-link">
              <i class="fab fa-facebook"></i> Facebook
            </a>
          `;
        }
        if (links.whatsapp) {
          const url = `https://wa.me/${links.whatsapp.number.replace(/\D/g, "")}?text=${encodeURIComponent(links.whatsapp.msg)}`;
          linksHTML += `
            <a href="${url}" target="_blank" class="social-link">
              <i class="fab fa-whatsapp"></i> WhatsApp
            </a>
          `;
        }
        
        socialLinks.innerHTML = linksHTML;
      } else {
        socialLinks.innerHTML = isCurrentUser 
          ? '<p style="color: #aaa;">No social links added yet</p>'
          : '<p style="color: #aaa;">No social links available</p>';
      }
    }

    // Edit social links
    async function editSocialLinks(currentLinks) {
      const { value: platform } = await Swal.fire({
        title: "Edit Social Links",
        input: "select",
        inputOptions: {
          youtube: "YouTube",
          facebook: "Facebook",
          whatsapp: "WhatsApp",
          remove: "Remove a link"
        },
        inputPlaceholder: "Select platform",
        showCancelButton: true,
      });

      if (!platform) return;

      const userRef = ref(db, `users/${currentUserUid}`);

      if (platform === "remove") {
        if (!currentLinks.youtube && !currentLinks.facebook && !currentLinks.whatsapp) {
          await Swal.fire("No links to remove");
          return;
        }

        const options = {};
        if (currentLinks.youtube) options.youtube = "YouTube";
        if (currentLinks.facebook) options.facebook = "Facebook";
        if (currentLinks.whatsapp) options.whatsapp = "WhatsApp";

        const { value: toRemove } = await Swal.fire({
          title: "Remove which link?",
          input: "select",
          inputOptions: options,
          showCancelButton: true,
        });

        if (toRemove) {
          const updatedLinks = { ...currentLinks };
          delete updatedLinks[toRemove];
          
          await update(userRef, { links: updatedLinks });
          updateSocialLinks(updatedLinks);
          Swal.fire("Link removed!");
        }
      } 
      else if (platform === "whatsapp") {
        const { value: action } = await Swal.fire({
          title: "WhatsApp Number",
          input: "radio",
          inputOptions: {
            use: `Use this phone (${currentLinks.whatsapp?.number || "Not set"})`,
            new: "Add another number"
          },
          inputValidator: v => !v && "Choose one"
        });

        let number = currentLinks.whatsapp?.number;
        if (action === "new") {
          const { value: newNumber } = await Swal.fire({
            title: "Enter Number",
            input: "text",
            inputLabel: "Include country code (e.g. +25261xxxxxx)",
            inputPlaceholder: "+25261xxxxxx",
            inputValidator: value => {
              if (!value) return "Required";
              if (!value.startsWith("+") || value.replace(/\D/g, "").length < 10) return "Invalid number";
              return null;
            }
          });
          number = newNumber;
        }

        const { value: msg } = await Swal.fire({
          title: "Enter Message",
          input: "text",
          inputPlaceholder: "e.g., Hello!",
          inputValidator: val => !val ? "Required" : null
        });

        if (number && msg) {
          const updatedLinks = {
            ...currentLinks,
            whatsapp: { number, msg }
          };
          
          await update(userRef, { links: updatedLinks });
          updateSocialLinks(updatedLinks);
          Swal.fire("WhatsApp saved!");
        }
      } 
      else {
        const { value: link } = await Swal.fire({
          title: `Enter ${platform} link`,
          input: "url",
          inputValue: currentLinks[platform] || "",
          inputPlaceholder: `https://${platform}.com/yourprofile`,
          inputValidator: value => {
            if (!value) return "Required";
            if (
              platform === "youtube" &&
              !value.startsWith("https://www.youtube.com/") &&
              !value.startsWith("https://youtube.com/")
            ) {
              return "Only valid YouTube links allowed";
            }
            if (
              platform === "facebook" &&
              !value.startsWith("https://www.facebook.com/") &&
              !value.startsWith("https://facebook.com/")
            ) {
              return "Only valid Facebook links allowed";
            }
            return null;
          }
        });

        if (link) {
          const updatedLinks = {
            ...currentLinks,
            [platform]: link
          };
          
          await update(userRef, { links: updatedLinks });
          updateSocialLinks(updatedLinks);
          Swal.fire(`${platform} link saved!`);
        }
      }
    }

    // Event listeners for buttons
    sendRequestBtn.addEventListener("click", async () => {
      const requestRef = ref(db, `friendRequests/${profileUserUid}/${currentUserUid}`);
      await update(requestRef, {
        status: "pending",
        from: currentUserUid,
        timestamp: Date.now()
      });
      sendRequestBtn.style.display = "none";
      Swal.fire("Friend request sent!");
    });

    followBtn.addEventListener("click", async () => {
      const followerRef = ref(db, `followers/${profileUserUid}/${currentUserUid}`);
      if (isFollowing) {
        await remove(followerRef);
        Swal.fire("Unfollowed");
      } else {
        await set(followerRef, true);
        Swal.fire("Followed");
      }
    });

    myFriendsBtn.addEventListener("click", () => {
      location.href = "friends.html";
    });
  </script>
</body>
</html>