<!DOCTYPE html>
<html lang="so">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Profile</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: white;
      text-align: center;
      padding: 30px;
    }
    .profile-card {
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      margin: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }
    .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #00cec9;
      margin-bottom: 10px;
      cursor: default;
    }
    h2 {
      margin: 10px 0;
    }
    .stat {
      margin: 8px 0;
      font-size: 18px;
    }
    button {
      margin: 10px 5px;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      border: none;
      cursor: pointer;
      color: white;
      background-color: #0984e3;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #74b9ff;
    }
    #sendRequestBtn {
      background-color: #00b894;
    }
    #sendRequestBtn:hover {
      background-color: #00cec9;
    }
    #messageBtn {
      background-color: #6c5ce7;
    }
    #messageBtn:hover {
      background-color: #a29bfe;
    }
    #followBtn {
      background-color: #fd79a8;
      display: none;
      margin-top: 10px;
    }
    #followBtn:hover {
      background-color: #e84393;
    }
    #sendGiftBtn {
      background-color: #fdcb6e;
      display: none;
    }
    #sendGiftBtn:hover {
      background-color: #ffeaa7;
      color: black;
    }
    #avatarOptions {
      margin-top: 20px;
      display: none;
      justify-content: center;
      gap: 15px;
    }
    #avatarOptions img {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.3s;
    }
    #avatarOptions img:hover {
      border-color: #00cec9;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <div class="profile-card" id="profileCard">
    <img src="avatars/default.png" alt="Avatar" class="avatar" id="avatarImg" title="User Avatar" />

    <div id="avatarOptions">
      <img src="avatars/avatar1.png" data-avatar="Somaliland" alt="Somaliland">
      <img src="avatars/avatar2.png" data-avatar="Somalia" alt="Somalia">
      <img src="avatars/avatar3.png" data-avatar="Djibouti" alt="Djibouti">
      <img src="avatars/avatar4.png" data-avatar="Ethiopia" alt="Ethiopia">
      <img src="avatars/avatar5.png" data-avatar="Uganda" alt="Uganda">
      <img src="avatars/avatar6.png" data-avatar="Kenya" alt="Kenya">
      <img src="avatars/default.png" data-avatar="default" alt="default">
    </div>

    <h2 id="usernameText">Loading...</h2>
    <div class="stat" id="winsText">Wins: 0</div>
    <div class="stat" id="playedText">Played: 0</div>
    <div class="stat" id="lossesText">Losses: 0</div>
    <div class="stat" id="coinsText">Coins Won: 0</div>
    <div class="stat" id="followersText">Followers: 0</div>

    <button id="sendRequestBtn">Send Friend Request</button>
    <button id="messageBtn" style="display: none;">Message</button>
    <button id="followBtn">Follow</button>
    <button id="sendGiftBtn">üéÅ Send Gift</button>
    <button id="myFriendsBtn">My Friends</button>
    <button class="back-btn" onclick="history.back()">‚¨ÖÔ∏è Back</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, update, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAj0xbIZhcmWiSf3nYVgIIgTZ_KJ64mTE",
      authDomain: "exam-81b90.firebaseapp.com",
      databaseURL: "https://exam-81b90-default-rtdb.firebaseio.com",
      projectId: "exam-81b90",
      storageBucket: "exam-81b90.appspot.com",
      messagingSenderId: "461178422237",
      appId: "1:461178422237:web:8433ab42b524b0a17bac34"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const uidParam = new URLSearchParams(location.search).get("uid");

    const avatarImg = document.getElementById("avatarImg");
    const avatarOptions = document.getElementById("avatarOptions");
    const usernameText = document.getElementById("usernameText");
    const winsText = document.getElementById("winsText");
    const playedText = document.getElementById("playedText");
    const lossesText = document.getElementById("lossesText");
    const coinsText = document.getElementById("coinsText");
    const followersText = document.getElementById("followersText");

    const sendRequestBtn = document.getElementById("sendRequestBtn");
    const messageBtn = document.getElementById("messageBtn");
    const myFriendsBtn = document.getElementById("myFriendsBtn");
    const followBtn = document.getElementById("followBtn");
    const sendGiftBtn = document.getElementById("sendGiftBtn");

    let currentUserUid = null;
    let profileUserUid = uidParam;
    let isCurrentUser = false;
    let friendsList = [];
    let isFollowing = false;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        await Swal.fire("Please login first");
        location.href = "login.html";
        return;
      }

      currentUserUid = user.uid;

      followersText.style.cursor = "pointer";
      followersText.style.textDecoration = "underline";
      followersText.addEventListener("click", () => {
        window.location.href = `followers.html?uid=${profileUserUid}`;
      });

      if (!profileUserUid) {
        await Swal.fire("User ID missing");
        return;
      }

      isCurrentUser = currentUserUid === profileUserUid;

      const userRef = ref(db, `users/${profileUserUid}`);
      const userSnap = await get(userRef);
      if (!userSnap.exists()) {
        await Swal.fire("User not found");
        return;
      }
      const userData = userSnap.val();
      const stats = userData.stats || {};
      const logo = userData.logo || "default";

      avatarImg.src = `${logo}.png`;
      usernameText.innerText = userData.username || "Unknown";
      winsText.innerText = `Wins: ${stats.wins || 0}`;
      playedText.innerText = `Played: ${stats.played || 0}`;
      lossesText.innerText = `Losses: ${stats.losses || 0}`;
      coinsText.innerText = `Coins Won: ${stats.totalcoinswon || 0}`;

      // Load friends list
      const friendsRef = ref(db, `friends/${currentUserUid}`);
      const friendsSnap = await get(friendsRef);
      friendsList = friendsSnap.exists() ? Object.keys(friendsSnap.val()) : [];

      // Check friend requests
      const requestRef = ref(db, `friendRequests/${profileUserUid}/${currentUserUid}`);
      const requestSnap = await get(requestRef);
      const alreadyRequested = requestSnap.exists();

      // Followers realtime update and follow button logic
      const followersRef = ref(db, `followers/${profileUserUid}`);
      onValue(followersRef, (snapshot) => {
        const followersData = snapshot.val() || {};
        const followerCount = Object.keys(followersData).length;
        followersText.innerText = `Followers: ${followerCount}`;

        isFollowing = currentUserUid in followersData;

        if (isCurrentUser) {
          followBtn.style.display = "none";
        } else {
          followBtn.style.display = "inline-block";
          followBtn.innerText = isFollowing ? "Unfollow" : "Follow";
        }
      });

      // Control visibility of send request, message, send gift buttons
      if (isCurrentUser) {
        sendRequestBtn.style.display = "none";
        messageBtn.style.display = "none";
        sendGiftBtn.style.display = "none";
      } else if (friendsList.includes(profileUserUid)) {
        sendRequestBtn.style.display = "none";
        messageBtn.style.display = "inline-block";
        sendGiftBtn.style.display = "block";
        messageBtn.onclick = () => {
          location.href = `chat.html?uid=${profileUserUid}`;
        };
        sendGiftBtn.onclick = () => {
          location.href = `sendgift.html?user=${profileUserUid}`;
        };
      } else if (alreadyRequested) {
        sendRequestBtn.style.display = "none";
        messageBtn.style.display = "none";
        sendGiftBtn.style.display = "none";
      } else {
        sendRequestBtn.style.display = "inline-block";
        messageBtn.style.display = "none";
        sendGiftBtn.style.display = "none";
      }

      // Avatar change UI for current user
      if (isCurrentUser) {
        avatarImg.style.cursor = "pointer";
        avatarImg.title = "Click to change avatar";
        avatarImg.addEventListener("click", () => {
          avatarOptions.style.display = avatarOptions.style.display === "flex" ? "none" : "flex";
        });
        avatarOptions.style.display = "flex";
        avatarOptions.querySelectorAll("img").forEach(img => {
          img.addEventListener("click", async () => {
            const selectedAvatar = img.getAttribute("data-avatar");
            try {
              await update(userRef, { logo: selectedAvatar });
              avatarImg.src = `${selectedAvatar}.png`;
              avatarOptions.style.display = "none";
              Swal.fire("Avatar updated!");
            } catch (e) {
              console.error(e);
              Swal.fire("Failed to update avatar");
            }
          });
        });
      } else {
        avatarOptions.style.display = "none";
        avatarImg.style.cursor = "default";
      }
    });

    sendRequestBtn.addEventListener("click", async () => {
      try {
        const requestRef = ref(db, `friendRequests/${profileUserUid}/${currentUserUid}`);
        const requestSnap = await get(requestRef);
        if (requestSnap.exists()) {
          Swal.fire("Request already sent");
          return;
        }
        await update(requestRef, {
          status: "pending",
          from: currentUserUid,
          timestamp: Date.now()
        });
        sendRequestBtn.style.display = "none";
        Swal.fire("Friend request sent!");
      } catch (e) {
        console.error(e);
        Swal.fire("Failed to send friend request");
      }
    });

    followBtn.addEventListener("click", async () => {
      if (!currentUserUid || !profileUserUid || isCurrentUser) return;

      const followerUserRef = ref(db, `followers/${profileUserUid}/${currentUserUid}`);

      try {
        if (isFollowing) {
          // Unfollow
          await remove(followerUserRef);
          Swal.fire("You unfollowed this user.");
        } else {
          // Follow
          await set(followerUserRef, true);
          Swal.fire("You followed this user.");
        }
      } catch (error) {
        console.error(error);
        Swal.fire("Failed to update follow status.");
      }
    });

    myFriendsBtn.addEventListener("click", () => {
      location.href = "friends.html";
    });
  </script>

</body>
</html>
