<!DOCTYPE html>
<html lang="so">
<head>
  <meta charset="UTF-8" />
  <title>Send Gift</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #2d3436;
      color: white;
      text-align: center;
      padding: 20px;
    }
    .profile {
      margin: 20px auto;
      padding: 20px;
      background: #636e72;
      border-radius: 10px;
      max-width: 400px;
    }
    img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      cursor: pointer;
    }
    select, button {
      padding: 10px;
      font-size: 16px;
      margin-top: 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    #giftInfo, #rec, #bim {
      margin-top: 10px;
      font-weight: bold;
    }
    #giftsList {
      margin-top: 20px;
      background: #444;
      border-radius: 8px;
      padding: 15px;
      text-align: left;
      font-size: 16px;
    }
    #partnerName {
      cursor: pointer;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <h2>Send Gift</h2>
  <div class="profile">
    <img id="partnerImg" src="avatars/default.png" alt="User Avatar" />
    <h3 id="partnerName">Loading...</h3>
    <p id="coinText">Coins: 0</p>

    <div id="giftsList">Loading gifts...</div>

    <select id="giftSelect">
      <option value="low">Low Gift</option>
      <option value="medium">Medium Gift</option>
      <option value="high">High Gift</option>
    </select>
    <div id="giftInfo">Gift Level: Low</div>

    <button id="sendBtn">Send Gift</button>
    <button onclick="loadFriends()">üë• My Friends</button>
    <button id="rec" onclick="rec()">Received Gifts</button>
    <button id="bim" onclick="buy()">Buy or Withdraw Gift</button>
    <br /><br />
    <button onclick="history.back()">‚¨ÖÔ∏è Back</button>
  </div>
  <script src="g.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, get, update, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBAj0xbIZhcmWiSf3nYVgIIgTZ_KJ64mTE",
    authDomain: "exam-81b90.firebaseapp.com",
    databaseURL: "https://exam-81b90-default-rtdb.firebaseio.com",
    projectId: "exam-81b90",
    storageBucket: "exam-81b90.appspot.com",
    messagingSenderId: "461178422237",
    appId: "1:461178422237:web:8433ab42b524b0a17bac34"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  const uid = new URLSearchParams(location.search).get("user");

  const giftSelect = document.getElementById("giftSelect");
  const giftInfo = document.getElementById("giftInfo");
  const partnerName = document.getElementById("partnerName");
  const partnerImg = document.getElementById("partnerImg");
  const coinText = document.getElementById("coinText");
  const giftsList = document.getElementById("giftsList");
  const sendBtn = document.getElementById("sendBtn");

  let currentUserUid;
  let currentUserData = {};

  giftSelect.addEventListener("change", () => {
    const val = giftSelect.value;
    giftInfo.innerText = `Gift Level: ${val.charAt(0).toUpperCase() + val.slice(1)}`;
  });

  function updateGiftsDisplay(giftsObj) {
    if (!giftsObj) {
      giftsList.innerText = "You have no gifts.";
      return;
    }
    let text = "Your Gifts:\n";
    text += `High: ${giftsObj.high || 0}\n`;
    text += `Medium: ${giftsObj.medium || 0}\n`;
    text += `Low: ${giftsObj.low || 0}`;
    giftsList.innerText = text;
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      Swal.fire("Fadlan gal account-ka");
      location.href = "login.html";
      return;
    }

    currentUserUid = user.uid;

    // Load target user info
    const userSnap = await get(ref(db, `users/${uid}`));
    if (!userSnap.exists()) {
      Swal.fire("User not found");
      return;
    }
    const userData = userSnap.val();
    const username = userData.username || "Unknown";

    partnerName.innerText = username;
    partnerImg.src = `${userData.logo || "avatars/default"}.png`;

    // Clickable profile redirects
    partnerImg.onclick = () => {
      window.location.href = `profile.html?uid=${uid}`;
    };
    partnerName.onclick = () => {
      window.location.href = `profile.html?uid=${uid}`;
    };

    // Load sender info
    const mySnap = await get(ref(db, `users/${currentUserUid}`));
    if (mySnap.exists()) {
      currentUserData = mySnap.val();
      coinText.innerText = `Coins: ${currentUserData.coins || 0}`;
      updateGiftsDisplay(currentUserData.gifts);
    } else {
      giftsList.innerText = "Error loading gifts.";
    }
  });

  sendBtn.addEventListener("click", async () => {
    const selectedGift = giftSelect.value;
    const gifts = currentUserData.gifts || {};
    const giftCount = gifts[selectedGift] || 0;

    if (giftCount < 1) {
      Swal.fire(`You don't have any ${selectedGift} gifts!`);
      return;
    }

    const confirm = await Swal.fire({
      title: `Send ${selectedGift} gift?`,
      text: `This will use 1 ${selectedGift} gift from your balance.`,
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "Yes, send it!"
    });

    if (!confirm.isConfirmed) return;

    try {
      // Decrease gift from sender
      gifts[selectedGift] = giftCount - 1;
      await update(ref(db, `users/${currentUserUid}/gifts`), {
        [selectedGift]: gifts[selectedGift]
      });
      currentUserData.gifts = gifts;
      updateGiftsDisplay(gifts);

      // Save gift to receiver
      await push(ref(db, `send/${uid}/${currentUserUid}`), {
        gift: selectedGift,
        timestamp: Date.now()
      });

      Swal.fire(`You sent a ${selectedGift} gift!`);

    } catch (e) {
      console.error(e);
      Swal.fire("Error sending gift.");
    }
  });

  // Load Friends
  window.loadFriends = async function () {
    try {
      const friendsRef = ref(db, `friends/${currentUserUid}`);
      const snapshot = await get(friendsRef);
      if (!snapshot.exists()) {
        Swal.fire("No friends found.");
        return;
      }

      const data = snapshot.val();
      const friendUIDs = Object.keys(data);
      if (friendUIDs.length === 0) {
        Swal.fire("You don't have any friends yet.");
        return;
      }

      const friendSnaps = await Promise.all(
        friendUIDs.map(uid => get(ref(db, `users/${uid}`)))
      );

      const html = friendSnaps.map((snap, i) => {
        const u = snap.val();
        const name = u.username || "Unknown";
        const logo = u.logo || "avatars/default";
        return `
          <div style="margin: 10px; display: flex; align-items: center; gap: 10px;">
            <img src="${logo}.png" style="width:40px;height:40px;border-radius:50%" />
            <span style="flex: 1;">${name}</span>
            <button onclick="changeTargetUID('${friendUIDs[i]}')">üéÅ Select</button>
          </div>
        `;
      }).join("");

      Swal.fire({
        title: "Choose a Friend",
        html,
        showConfirmButton: false,
        width: 400,
      });

    } catch (err) {
      console.error(err);
      Swal.fire("Error loading friends.");
    }
  };

  // Change UID to selected friend
  window.changeTargetUID = function (newUid) {
    const url = new URL(location.href);
    url.searchParams.set("user", newUid);
    window.location.href = url.toString();
  };
</script>

<script>
  function rec() {
    window.location.href = 'receive.html';
  }
  function buy() {
    window.location.href = 'gifts.html';
  }
</script>

</body>
</html>